<?php//require_once(ROOT_DIR."/classes/entities/band.php");/////////// INSERT INTO spieler (sp_name,sp_allianz)SELECT hs_name, hs_allianz FROM (SELECT hs_platz, hs_name, hs_allianz, hs_planetenpunkte,hs_forschungspunkte,hs_punkte,hs_planeten,hs_playercard FROM highscore ORDER BY hs_timestamp DESC) AS t1 GROUP BY hs_name ORDER BY hs_platz ASC////////////////// potentiell inaktive (keine punkte in den letzten N tagen):////	SELECT hs_name, min(hs_punkte), max(hs_punkte) from highscore where Date(hs_timestamp) >= date(current_timestamp)-N group by hs_name having min(hs_punkte)=max(hs_punkte) order by hs_punkte desc///////class HighscoreInterface extends BasicInterface {		public function __construct($db = null) {		parent::__construct($db);	}		public function toggleFavorit($data)	{		if (isset($data->player))		{			$q = "update spieler set sp_favorit=1-sp_favorit where sp_name='".$data->player."'";			$this->db->query($q);						$q = "select sp_favorit from spieler where sp_name='".$data->player."'";			$result=$this->db->query($q);			if ($this->db->get_last_num_rows() > 0)			{				$resultData = new stdClass;				while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) 				{					$favorit = $row['sp_favorit'];				}				$resultData->player = $data->player;				$resultData->favorit = $favorit;								return new DataResponse(ResultTypes::resultOK,"toggleFavorit",$resultData);			}			else			{				return new ErrorResponse('Spieler nicht gefunden!',$data);			}								}		else		{			return new ErrorResponse('Spieler muss angegeben werden!',$data);		}	}		public function getAllyDetails($data)	{		if (isset($data->ally))		{			$title = $data->ally;			$html = '';			$data->dotable = true;			$hs = $this->getCompleteHighscore($data);			$html .= $hs->data->html;						$resultData = new stdClass;			$resultData->html = $html;			$resultData->title = $title;						return new DataResponse(ResultTypes::resultOK,"getAllyDetails",$resultData);		}		else		{			return new ErrorResponse('Allianz muss angegeben werden!',$data);		}	}		public function getHighscoreHistory($data)	{		if (isset($data->player))		{					$html = '';			$data->dotable = false;			$hs = $this->getCompleteHighscore($data);			$html .= $hs->data->html;						$resultData = new stdClass;					$highscoredata = new stdClass;			$highscoredata->punkte = array();			$highscoredata->platz = array();			$highscoredata->planeten = array();			$q = "SELECT hs_timestamp, hs_punkte, hs_platz, hs_planeten from highscore where hs_name='".$data->player."' order by hs_timestamp asc";			$result=$this->db->query($q);			if ($this->db->get_last_num_rows() > 0)			{ 				while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) 				{					$punkterow = array();					$punkterow[] = $row['hs_timestamp'];					$punkterow[] = $row['hs_punkte'];					$highscoredata->punkte[] = $punkterow;										$platzrow = array();					$platzrow[] = $row['hs_timestamp'];					$platzrow[] = $row['hs_platz'];					$highscoredata->platz[] = $platzrow;										$planetenrow = array();					$planetenrow[] = $row['hs_timestamp'];					$planetenrow[] = $row['hs_planeten'];					$highscoredata->planeten[] = $planetenrow;				}				$html .= '<div id="highscoreverlauf"></div>';				$resultData->highscoredata = $highscoredata;			}						$resultData->html = $html;			$resultData->title = 'Highscoreverlauf '.$data->player;						return new DataResponse(ResultTypes::resultOK,"getHighscoreHistory",$resultData);		}		else		{			return new ErrorResponse('Spieler muss angegeben werden!',$data);		}					}		public function getCompleteHighscore($data)	{		//$q = "SELECT * from highscore order by hs_platz asc, hs_timestamp asc";				$where = " ";				if (isset($data->favoriten)) 		{			$where = " where sp_favorit=1 ";		}		else		{			if (isset($data->player))			{				$where .= "where hs_name='".$data->player."' ";			}			if (isset($data->ally))			{				if ($where == " ")				{					$where = " where ";				}				else				{					$where .= " and ";				}				$where .= " hs_allianz='".$data->ally."' ";			}		}				$q = "SELECT * FROM (SELECT hs_platz, hs_name, hs_allianz, hs_planetenpunkte,hs_forschungspunkte,hs_punkte,hs_planeten,hs_playercard,sp_favorit FROM highscore left join spieler on hs_name=sp_name".$where."ORDER BY hs_timestamp DESC) AS t1 GROUP BY hs_name ORDER BY hs_platz ASC";				$result=$this->db->query($q);				$bla = 0;				$html = '';				if ($this->db->get_last_num_rows() > 0)		{ 			$html = $this->getHtmlTableOpen($this->getTableClasses($data));			$html .= $this->getHtmlTableHeader(['Platz','Name','Allianz','Planetenpkt.','Forsch.','Punkte','Planeten']);			$html .= '<tbody>';			//$html = '<table class="auswertung getCompleteHighscore'.(isset($data->popup) ? ' popup' : '').(isset($data->dotable) ? ' dotable' : '').'"><thead><tr><th>Platz</th><th>Name</th><th>Allianz</th><th>Planetenpkt.</th><th>Forschungspkt.</th><th>Punkte</th><th>Planeten</th></thead></tr><tbody>';			while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) 			{				$bla++;				
				$html .= '<tr>';
								foreach($row as $key => $value)				{					if ($key != 'hs_playercard' && $key != 'sp_favorit') {						if ($key == 'hs_name')						{							if ($row['hs_playercard'] == '')							{								$html .= '<td>'.$value;							}							else							{								$html .= '<td><a href="http://uni1.gigrawars.de/playercard.php?u='.$row['hs_playercard'].'">'.$value.'</a>';							}							$html .= $this->getHtmlAllPlanetByPlayerIcon($row['hs_name']);							$html .= $this->getHtmlHighscoreHistoryIcon($row['hs_name']);							$html.= $this->getHtmlFavoritIcon($row['hs_name'],$row['sp_favorit']);														$html .= '</td>';						}						else if ($key == 'hs_allianz')						{							if ($value != '')							{								$html .= '<td>'.$value.'<div title="Allianz: '.$row['hs_allianz'].'" class="ally icon" onclick="ajaxMessageBox(\'HighscoreInterface\',\'getAllyDetails\',{ ally:\''.$row['hs_allianz'].'\', highscore: true })"></div></td>';							}							else							{								$html .= '<td>'.$value.'</td>';							}						}						else						{							$html .= '<td>'.$value.'</td>';						}					}				}				$html .= '</tr>';			}			$html .= '</tbody></table>';		}
		else
		{
			$html .= '<p>Nicht genug Daten gesammelt!</p>';
		}				$resultData = new stdClass;		$resultData->html = $html;				return new DataResponse(ResultTypes::resultOK,"getCompleteHighscore",$resultData);	}		public function getInactivePlayers($data)	{		$where = " ";				$days = (isset($data->days) ? $data->days : 10000);				if (isset($data->favoriten)) 		{			$where = " and sp_favorit=1 ";		}		else		{			if (isset($data->player))			{				$where .= " and hs_name='".$data->player."' ";			}			if (isset($data->ally))			{				$where .= " and hs_allianz='".$data->ally."' ";			}		}				$q = "SELECT max(hs_punkte) as punkte_max,hs_name, hs_allianz, min(hs_punkte) as punkte_min,hs_playercard,sp_favorit from highscore left join spieler on hs_name=sp_name where Date(hs_timestamp) >= date(current_timestamp)-".$days.$where." group by hs_name having min(hs_punkte)=max(hs_punkte) order by hs_punkte desc";			$result=$this->db->query($q);				$bla = 0;				$html = '';				if ($this->db->get_last_num_rows() > 0)		{ 			$html = $this->getHtmlTableOpen($this->getTableClasses($data));			$html .= $this->getHtmlTableHeader(['Punkte','Name','Allianz']);			$html .= '<tbody>';			while ($row = mysql_fetch_array($result, MYSQL_ASSOC)) 			{				$bla++;								$html .= '<tr>';								foreach($row as $key => $value)				{					if ($key != 'hs_playercard' && $key != 'sp_favorit') {						if ($key == 'hs_name')						{							if ($row['hs_playercard'] == '')							{								$html .= '<td>'.$value;							}							else							{								$html .= '<td><a href="http://uni1.gigrawars.de/playercard.php?u='.$row['hs_playercard'].'">'.$value.'</a>';							}							$html .= $this->getHtmlAllPlanetByPlayerIcon($row['hs_name']);							$html .= $this->getHtmlHighscoreHistoryIcon($row['hs_name']);							$html.= $this->getHtmlFavoritIcon($row['hs_name'],$row['sp_favorit']);														$html .= '</td>';						}						else if ($key == 'hs_allianz')						{							if ($value != '')							{								$html .= '<td>'.$value.'<div title="Allianz: '.$row['hs_allianz'].'" class="ally icon" onclick="ajaxMessageBox(\'HighscoreInterface\',\'getAllyDetails\',{ ally:\''.$row['hs_allianz'].'\', highscore: true })"></div></td>';							}							else							{								$html .= '<td>'.$value.'</td>';							}						}						else if ($key == "punkte_max")						{							$html .= '<td>'.$value.'</td>';						}					}				}				$html .= '</tr>';			}			$html .= '</tbody></table>';		}		else		{			$html .= '<p>Nicht genug Daten gesammelt!</p>';		}						$resultData = new stdClass;		$resultData->html = $html;				return new DataResponse(ResultTypes::resultOK,"getInactivePlayers",$resultData);		}}HighscoreInterface::registerInterface();?>